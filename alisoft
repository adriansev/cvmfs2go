#!/usr/bin/env bash

export PATH=".:${PATH}"
export CVMFS_REPOSITORIES_EXCLUSIVE="alice.cern.ch,alice-ocdb.cern.ch"
export TMPDIR="${TMPDIR:-/tmp}"

do_ali_line () {
local list output_str
list="${1}"
output_str=""

IFS=',' read -ra list_arr <<< "${list}"
for i in "${list_arr[@]}"; do
    output_str="${output_str}${output_str:+,}VO_ALICE@${i}"
done
echo -ne "${output_str}"
}

ACTION="${1}"
if [[ "${ACTION}" == "enter" ]]; then
    shift
    ALI_MODULE="${1}"
    shift
    exec cvmfs2go /cvmfs/alice.cern.ch/bin/alienv enter "$(do_ali_line ${ALI_MODULE})"
elif [[ "${ACTION}" == "load" ]]; then
    shift
    ALI_MODULE="${1}"
    shift
    mod_list="$(do_ali_line ${ALI_MODULE})"
    tmp_filename="$(echo -n ${mod_list} | md5sum | cut -d' ' -f1)"
    tmp_file="${TMPDIR}/${tmp_filename}"
    /cvmfs/alice.cern.ch/bin/alienv printenv "${mod_list}" > "${tmp_file}"
    SINGULARITY_CVMFS2GO=" --env-file ${tmp_file} "  # singularity options should be defined only here!!
    exec cvmfs2go "${@}"
    [[ -e "${tmp_file}" ]] && rm -f "${tmp_file}"
else
    exec cvmfs2go "${@}"
fi

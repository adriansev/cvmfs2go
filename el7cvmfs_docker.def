Bootstrap: docker
From: centos:centos7
Include: yum yum-utils bash bash-completion util-linux coreutils sudo curl fuse fuse-libs fuse3 fuse3-libs bindfs

%labels
    Author Adrian.Sevcenco@spacescience.ro
    Version 0.0.1
    Description Minimal el7, HEP_OSlibs + cvmfs (configs: default+egi+osg) container


%help
Generic HEP oriented container (it includes HEP_OSlibs dependency list)
that allows mounting of CVMFS repositories without any host requirement.
The proxies are defined as generic PAC urls, with fallback to DIRECT.
CVMFS configuration is the merge of cvmfs-config-default cvmfs-config-egi cvmfs-config-osg
The container can be pre-setup by the usage of files prefixed with CVMFS2GO_EXEC_ or CVMFS2GO_LOAD_
in the current directory on home directory. (the ones from current directory take precedence)
If given as 1st argument a name that start with CVMFS2GO_LOAD_ it will be sourced before running a command or starting the shell
If given as 1st argument a name that start with CVMFS2GO_EXEC_ the first line of file will be executed
The default is either run the argument list or just start bash

%setup
mkdir -p ${SINGULARITY_ROOTFS}/etc/cvmfs
cp -r etc_cvmfs/ ${SINGULARITY_ROOTFS}/etc/cvmfs/

%files
default.local /etc/cvmfs/default.local
sudoers_cvmfs /etc/sudoers

%post
# replace centos base links
yum-config-manager --save --setopt=base.baseurl=http://monitor.spacescience.ro/mirrors/centos/7/os/x86_64/ &>/dev/null
yum-config-manager --save --setopt=base.keepcache=False &>/dev/null

yum-config-manager --save --setopt=updates.baseurl=http://monitor.spacescience.ro/mirrors/centos/7/updates/x86_64/ &>/dev/null
yum-config-manager --save --setopt=updates.keepcache=False &>/dev/null

yum-config-manager --save --setopt=extras.baseurl=http://monitor.spacescience.ro/mirrors/centos/7/extras/x86_64/ &>/dev/null
yum-config-manager --save --setopt=extras.keepcache=False &>/dev/null

yum-config-manager --save --setopt=centosplus.baseurl=http://monitor.spacescience.ro/mirrors/centos/7/centosplus/x86_64/ &>/dev/null
yum-config-manager --save --setopt=centosplus.keepcache=False &>/dev/null

yum-config-manager --save --setopt=epel.baseurl=http://monitor.spacescience.ro/mirrors/epel/7/x86_64/ &>/dev/null
yum-config-manager --save --setopt=epel.keepcache=False &>/dev/null

yum-config-manager --save --setopt=epel-debuginfo.baseurl=http://monitor.spacescience.ro/mirrors/epel/7/x86_64/debug/ &>/dev/null
yum-config-manager --save --setopt=epel-debuginfo.keepcache=False &>/dev/null

yum-config-manager --save --setopt=epel-source.baseurl=http://monitor.spacescience.ro/mirrors/epel/7/SRPMS/ &>/dev/null
yum-config-manager --save --setopt=epel-source.keepcache=False &>/dev/null

yum -y update && yum -y install \
https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm \
https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm \
https://linuxsoft.cern.ch/wlcg/centos7/x86_64/wlcg-repo-1.0.0-1.el7.noarch.rpm \
http://repository.egi.eu/sw/production/umd/4/centos7/x86_64/updates/umd-release-4.1.3-1.el7.centos.noarch.rpm;
yum-config-manager --disable UMD*;
yum install -y HEP_OSlibs cvmfs cvmfs-fuse3 --disablerepo=UMD*;
yum install -y cvmfs-x509-helper --enablerepo=UMD*

rm -rf /var/cache/yum;

%runscript
ARG="${1}"

if [[ ${ARG} == CVMFS2GO_LOAD_*  ]]; then
    shift
    # check existence of file in current dir then in $HOME
    if [[ -e ./${ARG} ]]; then
        source ./${ARG}
    elif [[ -e ${HOME}/${ARG} ]]; then
        source ${HOME}/${ARG}
    fi
fi

if [[ ${ARG} == CVMFS2GO_EXEC_*  ]]; then
    shift
    # check existence of file in current dir then in $HOME
    if [[ -e ${ARG} ]]; then
        exec $(head -1 ${ARG})
    elif [[ -e ${HOME}/${ARG} ]]; then
        exec $(head -1 ${HOME}/${ARG})
    fi
fi

[[ -n "${@}" ]] && exec "${@}" || bash

